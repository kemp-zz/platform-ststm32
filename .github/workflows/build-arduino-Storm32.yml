name: Build Arduino IDE project for Storm32

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
      env:
        PIO_SECRETS: ${{ secrets.PIO_SECRETS }}
    steps:
      - uses: actions/checkout@v3

      - name: Create Project Folder structure
        run: |
          mkdir -p src
          mkdir -p lib
      

      - name: Generate storm32.ino file
        run: |
          echo "#include <Arduino.h>" >> src/storm32.ino
          echo "void setup() {" >> src/storm32.ino
          echo "  Serial.begin(9600);" >> src/storm32.ino
          echo "}" >> src/storm32.ino
          echo "void loop() {" >> src/storm32.ino
          echo "  Serial.println(\"Hello, Storm32!\");" >> src/storm32.ino
          echo "  delay(1000);" >> src/storm32.ino
          echo "}" >> src/storm32.ino

      - name: Install platformio dependencies
        run: pio ci --dependencies

      - name: Build Project
        run: |
          cd src
          pio run -e storm32
          make upload_storm32

      - name: Upload output binary
        uses: actions/upload-artifact@v3
        with:
          name: binary
          path: build/storm32.elf
          retention-days: 1
